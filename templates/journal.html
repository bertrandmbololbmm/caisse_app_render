{% extends 'layout.html' %}{% block content %}
<h3>Journal</h3>
<form class="row g-2 mb-3">
  <div class="col-md-2"><label class="form-label">Début</label><input type="date" name="start" value="{{ start or '' }}" class="form-control"></div>
  <div class="col-md-2"><label class="form-label">Fin</label><input type="date" name="end" value="{{ end or '' }}" class="form-control"></div>
  <div class="col-md-2"><label class="form-label">Type</label>
    <select class="form-select" name="type">
      <option value="">Tous</option>
      <option value="entree" {{ 'selected' if type_filter=='entree' }}>Entrées</option>
      <option value="vente" {{ 'selected' if type_filter=='vente' }}>Ventes</option>
      <option value="depense" {{ 'selected' if type_filter=='depense' }}>Dépenses</option>
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Catégorie</label>
    <select class="form-select" name="category">
      <option value="">Toutes</option>
      {% for c in cats %}<option value="{{ c.id }}" {{ 'selected' if request.args.get('category', type=int)==c.id }}>{{ c.name }}</option>{% endfor %}
    </select>
  </div>
  <div class="col-md-3 d-flex align-items-end">
    <button class="btn btn-primary me-2">Filtrer</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('journal') }}">Réinitialiser</a>
  </div>
</form>

<div class="row mb-2">
  <div class="col"><div class="card"><div class="card-body">Entrées: <b>{{ '%.0f'|format(summary.entree) }}</b></div></div></div>
  <div class="col"><div class="card"><div class="card-body">Ventes: <b>{{ '%.0f'|format(summary.vente) }}</b></div></div></div>
  <div class="col"><div class="card"><div class="card-body">Dépenses: <b>{{ '%.0f'|format(summary.depense) }}</b></div></div></div>
  <div class="col"><div class="card"><div class="card-body">Solde: <b>{{ '%.0f'|format(summary.solde) }}</b></div></div></div>
</div>

<table class="table table-striped table-sm align-middle">
  <thead><tr>
    <th>Date</th><th>Type</th><th>Libellé</th><th>Catégorie</th><th class="text-end">Montant</th><th>Note</th><th>Solde</th><th></th>
  </tr></thead>
  <tbody>
  {% for o in rows %}
    <tr>
      <td>{{ o.date }}</td>
      <td class="text-uppercase">{{ o.type }}</td>
      <td>
        {{ o.label }}
        {% if o.type=='vente' and o.designation %}
          <div class="text-muted small">{{ o.designation }}{% if o.quantity %} — {{ o.quantity }} @ {{ o.unit_price }}{% endif %}</div>
        {% endif %}
      </td>
      <td>{{ o.category.name if o.category }}</td>
      <td class="text-end">{{ '%.0f'|format(o.amount) }}</td>
      <td class="small">{{ o.note or '' }}</td>
      <td class="text-end">{{ '%.0f'|format(balance[loop.index0]) }}</td>
      <td class="text-nowrap">
        {% if current_user.role in ['admin','editor'] and (current_user.role=='admin' or current_user.id==o.user_id) %}
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('op_edit', op_id=o.id) }}">Modifier</a>
          <form method="post" action="{{ url_for('op_delete', op_id=o.id) }}" style="display:inline" onsubmit="return confirm('Supprimer ?')">
            <button class="btn btn-sm btn-outline-danger">Supprimer</button>
          </form>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endblock %}
